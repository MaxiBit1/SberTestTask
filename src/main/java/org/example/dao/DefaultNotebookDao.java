package org.example.dao;

import lombok.extern.slf4j.Slf4j;
import org.example.config.JDBCConfig;
import org.example.dto.NotebookDto;
import org.example.rowMapper.NotebookMapper;
import org.example.validation.ValidationNotebookDto;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

@Slf4j
public class DefaultNotebookDao implements NotebookDao {

    @Override
    public void createTableNotebook() throws SQLException {
        String sqlQuery = "CREATE TABLE public.notebooks(" +
                "id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY," +
                "model_name VARCHAR(50)," +
                "company_name VARCHAR(50)," +
                "size_ram INTEGER," +
                "size_pzu INTEGER," +
                "resolution VARCHAR(20)," +
                "price DECIMAL)";
        Statement statement = JDBCConfig.getConnection().createStatement();
        statement.executeUpdate(sqlQuery);
        log.info("Class DefaultNotebookDao: create table notebooks");
        JDBCConfig.closeConnection();

    }

    @Override
    public List<NotebookDto> selectAllNotebooks() throws SQLException {
        String sqlQuery = "SELECT * FROM public.notebooks";
        Statement statement = JDBCConfig.getConnection().createStatement();
        boolean hasResult = statement.execute(sqlQuery);
        if (!hasResult) {
            return List.of(null);
        }
        List<NotebookDto> listDto = new ArrayList<>();
        ResultSet resultSet = statement.getResultSet();
        while (resultSet.next()) {
            listDto.add(NotebookMapper.makeNotebookDto(resultSet));
        }
        log.info("Class DefaultNotebookDao: Get all notebooks");
        JDBCConfig.closeConnection();
        return listDto;
    }

    @Override
    public List<NotebookDto> selectNotebooksWithParameters(String parameters, String operator, String value) throws SQLException {
        StringBuilder sqlQuery = new StringBuilder("SELECT * FROM notebooks WHERE ");
        String resultWhere = createWhere(parameters, operator, value);
        sqlQuery.append(resultWhere);
        Statement statement = JDBCConfig.getConnection().createStatement();
        List<NotebookDto> listDto = new ArrayList<>();
        ResultSet resultSet = statement.executeQuery(sqlQuery.toString());
        while (resultSet.next()) {
            listDto.add(NotebookMapper.makeNotebookDto(resultSet));
        }
        if (listDto.isEmpty()) {
            return List.of(null);
        }
        JDBCConfig.closeConnection();
        log.info("Class DefaultNotebookDao: Get notebooks with parameters {}, operator {}, value {}", parameters, operator, value);
        return listDto;
    }

    @Override
    public void addNotebook(NotebookDto notebookDto) throws SQLException {
        ValidationNotebookDto.validationDto(notebookDto);
        StringBuilder sqlQuery = new StringBuilder("INSERT INTO notebooks(model_name, company_name, size_ram, size_pzu, resolution, price) ");
        sqlQuery.append("VALUES(")
                .append("'")
                .append(notebookDto.getModelName())
                .append("'")
                .append(",")
                .append("'")
                .append(notebookDto.getCompanyName())
                .append("'")
                .append(",")
                .append(notebookDto.getSizeRam())
                .append(",")
                .append(notebookDto.getSizePZU())
                .append(",")
                .append("'")
                .append(notebookDto.getResolution())
                .append("'")
                .append(",")
                .append(notebookDto.getPrice())
                .append(")");
        Statement statement = JDBCConfig.getConnection().createStatement();
        statement.executeUpdate(sqlQuery.toString());
        log.info("Class DefaultNotebookDao: Insert notebook with data: modelName - {}, company_name - {}, sizeRam - {}, sizePZU - {}, resolution - {}, price - {}",
                notebookDto.getModelName(), notebookDto.getCompanyName(), notebookDto.getSizeRam(), notebookDto.getSizePZU(), notebookDto.getResolution(), notebookDto.getPrice());
        JDBCConfig.closeConnection();
    }

    @Override
    public void deleteNotebook(String parameters, String operator, String value) throws SQLException {
        StringBuilder sqlQueryDelete = new StringBuilder("DELETE FROM notebooks WHERE ");
        String sqlWhere = createWhere(parameters, operator, value);
        sqlQueryDelete.append(sqlWhere);
        Statement statement = JDBCConfig.getConnection().createStatement();
        statement.executeUpdate(sqlQueryDelete.toString());
        log.info("Class DefaultNotebookDao: Delete data from table with parameters {} {} {}", parameters, operator, value);
        JDBCConfig.closeConnection();
    }

    @Override
    public void dropTable() throws SQLException {
        Statement statement = JDBCConfig.getConnection().createStatement();
        statement.executeUpdate("DROP TABLE notebooks");
        log.info("Class DefaultNotebookDao: Drop table notebooks");
        JDBCConfig.closeConnection();
    }

    private String createWhere(String parameters, String operator, String value) {
        StringBuilder stringBuilder = new StringBuilder();
        if (parameters.isEmpty() || operator.isEmpty() || value.isEmpty()) {
            return "1=1";
        }
        return stringBuilder
                .append(parameters)
                .append(operator)
                .append(value)
                .toString();
    }
}
